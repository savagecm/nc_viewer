#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
åˆ›å»ºç¤ºä¾‹NCæ–‡ä»¶ç”¨äºæµ‹è¯•3Då¯è§†åŒ–å™¨

è¿™ä¸ªè„šæœ¬ä¼šç”Ÿæˆä¸€ä¸ªåŒ…å«æ¨¡æ‹Ÿæ°”è±¡æ•°æ®çš„NetCDFæ–‡ä»¶ï¼Œ
å¯ä»¥ç”¨æ¥æµ‹è¯•3D NCæ–‡ä»¶å¯è§†åŒ–å™¨çš„åŠŸèƒ½ã€‚
"""

import numpy as np
import netCDF4 as nc
from datetime import datetime, timedelta
import os

def create_sample_temperature_data():
    """åˆ›å»ºç¤ºä¾‹æ¸©åº¦æ•°æ®"""
    print("æ­£åœ¨åˆ›å»ºç¤ºä¾‹æ¸©åº¦æ•°æ®...")
    
    # å®šä¹‰ç½‘æ ¼
    lat_range = np.arange(-90, 91, 2)  # çº¬åº¦: -90åˆ°90åº¦ï¼Œé—´éš”2åº¦
    lon_range = np.arange(-180, 180, 2)  # ç»åº¦: -180åˆ°180åº¦ï¼Œé—´éš”2åº¦
    
    # åˆ›å»ºç½‘æ ¼
    lon_grid, lat_grid = np.meshgrid(lon_range, lat_range)
    
    # ç”Ÿæˆæ¨¡æ‹Ÿæ¸©åº¦æ•°æ®ï¼ˆåŸºäºçº¬åº¦çš„æ¸©åº¦åˆ†å¸ƒï¼‰
    # èµ¤é“é™„è¿‘æ¸©åº¦é«˜ï¼Œä¸¤ææ¸©åº¦ä½
    base_temp = 15 - 0.5 * np.abs(lat_grid)  # åŸºç¡€æ¸©åº¦åˆ†å¸ƒ
    
    # æ·»åŠ ä¸€äº›éšæœºå˜åŒ–å’Œåœ°ç†ç‰¹å¾
    noise = np.random.normal(0, 3, lat_grid.shape)  # éšæœºå™ªå£°
    seasonal_effect = 5 * np.sin(np.radians(lon_grid / 2))  # å­£èŠ‚æ€§æ•ˆåº”
    
    temperature = base_temp + noise + seasonal_effect
    
    return lat_range, lon_range, temperature

def create_sample_precipitation_data():
    """åˆ›å»ºç¤ºä¾‹é™æ°´æ•°æ®"""
    print("æ­£åœ¨åˆ›å»ºç¤ºä¾‹é™æ°´æ•°æ®...")
    
    # å®šä¹‰ç½‘æ ¼
    lat_range = np.arange(-60, 61, 1.5)  # çº¬åº¦èŒƒå›´ç¨å°ï¼Œåˆ†è¾¨ç‡æ›´é«˜
    lon_range = np.arange(-120, 121, 1.5)  # ç»åº¦èŒƒå›´ç¨å°ï¼Œåˆ†è¾¨ç‡æ›´é«˜
    
    # åˆ›å»ºç½‘æ ¼
    lon_grid, lat_grid = np.meshgrid(lon_range, lat_range)
    
    # ç”Ÿæˆæ¨¡æ‹Ÿé™æ°´æ•°æ®
    # çƒ­å¸¦åœ°åŒºé™æ°´å¤šï¼Œå¹²æ—±åœ°åŒºé™æ°´å°‘
    tropical_rain = 200 * np.exp(-((lat_grid)**2) / 400)  # çƒ­å¸¦é™æ°´å¸¦
    monsoon_effect = 100 * np.sin(np.radians(lon_grid)) * np.cos(np.radians(lat_grid * 2))
    random_variation = np.random.exponential(20, lat_grid.shape)  # æŒ‡æ•°åˆ†å¸ƒçš„éšæœºå˜åŒ–
    
    precipitation = np.maximum(0, tropical_rain + monsoon_effect + random_variation)
    
    return lat_range, lon_range, precipitation

def create_sample_wind_data():
    """åˆ›å»ºç¤ºä¾‹é£é€Ÿæ•°æ®"""
    print("æ­£åœ¨åˆ›å»ºç¤ºä¾‹é£é€Ÿæ•°æ®...")
    
    # å®šä¹‰ç½‘æ ¼
    lat_range = np.arange(-80, 81, 2.5)
    lon_range = np.arange(-180, 180, 2.5)
    
    # åˆ›å»ºç½‘æ ¼
    lon_grid, lat_grid = np.meshgrid(lon_range, lat_range)
    
    # ç”Ÿæˆæ¨¡æ‹Ÿé£é€Ÿæ•°æ®
    # åŸºäºç§‘é‡Œå¥¥åˆ©æ•ˆåº”å’Œçº¬åº¦çš„é£é€Ÿåˆ†å¸ƒ
    westerlies = 15 * np.exp(-((lat_grid - 45)**2) / 200)  # è¥¿é£å¸¦
    trade_winds = 10 * np.exp(-((np.abs(lat_grid) - 15)**2) / 100)  # ä¿¡é£å¸¦
    polar_winds = 8 * np.exp(-((np.abs(lat_grid) - 70)**2) / 50)  # æåœ°é£
    
    wind_speed = westerlies + trade_winds + polar_winds + np.random.normal(0, 2, lat_grid.shape)
    wind_speed = np.maximum(0, wind_speed)  # ç¡®ä¿é£é€Ÿéè´Ÿ
    
    return lat_range, lon_range, wind_speed

def create_netcdf_file(filename, lat, lon, data, variable_name, units, long_name):
    """åˆ›å»ºNetCDFæ–‡ä»¶"""
    print(f"æ­£åœ¨åˆ›å»ºNetCDFæ–‡ä»¶: {filename}")
    
    # åˆ›å»ºNetCDFæ–‡ä»¶
    dataset = nc.Dataset(filename, 'w', format='NETCDF4')
    
    # åˆ›å»ºç»´åº¦
    lat_dim = dataset.createDimension('lat', len(lat))
    lon_dim = dataset.createDimension('lon', len(lon))
    time_dim = dataset.createDimension('time', None)  # æ— é™ç»´åº¦
    
    # åˆ›å»ºåæ ‡å˜é‡
    latitudes = dataset.createVariable('lat', 'f4', ('lat',))
    longitudes = dataset.createVariable('lon', 'f4', ('lon',))
    times = dataset.createVariable('time', 'f8', ('time',))
    
    # åˆ›å»ºæ•°æ®å˜é‡
    var = dataset.createVariable(variable_name, 'f4', ('time', 'lat', 'lon',), 
                                fill_value=-9999.0)
    
    # è®¾ç½®åæ ‡å˜é‡çš„å±æ€§
    latitudes.units = 'degrees_north'
    latitudes.long_name = 'latitude'
    latitudes.standard_name = 'latitude'
    
    longitudes.units = 'degrees_east'
    longitudes.long_name = 'longitude'
    longitudes.standard_name = 'longitude'
    
    times.units = 'hours since 2024-01-01 00:00:00'
    times.long_name = 'time'
    times.calendar = 'gregorian'
    
    # è®¾ç½®æ•°æ®å˜é‡çš„å±æ€§
    var.units = units
    var.long_name = long_name
    var.standard_name = variable_name
    var.coordinates = 'time lat lon'
    
    # å†™å…¥æ•°æ®
    latitudes[:] = lat
    longitudes[:] = lon
    times[0] = 0  # ç¬¬ä¸€ä¸ªæ—¶é—´æ­¥
    var[0, :, :] = data
    
    # æ·»åŠ å…¨å±€å±æ€§
    dataset.title = f'Sample {long_name} Data for 3D Visualization'
    dataset.institution = '3D NC Viewer Sample Data Generator'
    dataset.source = 'Synthetic data for testing purposes'
    dataset.history = f'Created on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}'
    dataset.references = 'Generated by create_sample_nc.py'
    dataset.comment = 'This is synthetic data created for testing the 3D NC file visualizer'
    dataset.Conventions = 'CF-1.6'
    
    # å…³é—­æ–‡ä»¶
    dataset.close()
    print(f"âœ… æ–‡ä»¶åˆ›å»ºå®Œæˆ: {filename}")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸŒ 3D NCæ–‡ä»¶å¯è§†åŒ–å™¨ - ç¤ºä¾‹æ•°æ®ç”Ÿæˆå™¨")
    print("=" * 50)
    
    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº†netCDF4
    try:
        import netCDF4
    except ImportError:
        print("âŒ é”™è¯¯: éœ€è¦å®‰è£…netCDF4åº“")
        print("è¯·è¿è¡Œ: pip install netCDF4")
        return
    
    # åˆ›å»ºç¤ºä¾‹æ•°æ®
    datasets = [
        {
            'func': create_sample_temperature_data,
            'filename': 'sample_temperature.nc',
            'variable': 'temperature',
            'units': 'degrees_C',
            'long_name': 'Air Temperature'
        },
        {
            'func': create_sample_precipitation_data,
            'filename': 'sample_precipitation.nc',
            'variable': 'precipitation',
            'units': 'mm/day',
            'long_name': 'Daily Precipitation'
        },
        {
            'func': create_sample_wind_data,
            'filename': 'sample_wind_speed.nc',
            'variable': 'wind_speed',
            'units': 'm/s',
            'long_name': 'Wind Speed'
        }
    ]
    
    created_files = []
    
    for dataset_info in datasets:
        try:
            # ç”Ÿæˆæ•°æ®
            lat, lon, data = dataset_info['func']()
            
            # åˆ›å»ºNetCDFæ–‡ä»¶
            create_netcdf_file(
                dataset_info['filename'],
                lat, lon, data,
                dataset_info['variable'],
                dataset_info['units'],
                dataset_info['long_name']
            )
            
            created_files.append(dataset_info['filename'])
            
        except Exception as e:
            print(f"âŒ åˆ›å»º {dataset_info['filename']} æ—¶å‡ºé”™: {e}")
    
    # æ˜¾ç¤ºç»“æœ
    print("\n" + "=" * 50)
    print("ğŸ“Š ç¤ºä¾‹æ•°æ®æ–‡ä»¶åˆ›å»ºå®Œæˆ!")
    print("\nåˆ›å»ºçš„æ–‡ä»¶:")
    
    for filename in created_files:
        if os.path.exists(filename):
            size = os.path.getsize(filename) / 1024  # KB
            print(f"  âœ… {filename} ({size:.1f} KB)")
        else:
            print(f"  âŒ {filename} (åˆ›å»ºå¤±è´¥)")
    
    print("\nğŸ’¡ ä½¿ç”¨è¯´æ˜:")
    print("1. å¯åŠ¨3Då¯è§†åŒ–å™¨: python3 start_server.py")
    print("2. åœ¨æµè§ˆå™¨ä¸­åŠ è½½ä¸Šè¿°ä»»ä¸€NCæ–‡ä»¶")
    print("3. é€‰æ‹©å¯¹åº”çš„å˜é‡è¿›è¡Œå¯è§†åŒ–")
    print("\nğŸ¯ æ¨èæµ‹è¯•é¡ºåº:")
    print("   - sample_temperature.nc (æ¸©åº¦æ•°æ®ï¼Œå…¨çƒè¦†ç›–)")
    print("   - sample_precipitation.nc (é™æ°´æ•°æ®ï¼Œé«˜åˆ†è¾¨ç‡)")
    print("   - sample_wind_speed.nc (é£é€Ÿæ•°æ®ï¼Œä¸­ç­‰åˆ†è¾¨ç‡)")
    
if __name__ == '__main__':
    main()